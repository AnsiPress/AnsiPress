---

- name: Check /swapfile file
  ansible.builtin.stat: path="/swapfile"
  register: swapfile_exist
  tags: swap, resize_plan

- name: Create swap file
  ansible.builtin.command: dd if=/dev/zero of=/swapfile bs=1M count={{ swap_size|int * 1024 }}
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Fix swap file permission
  ansible.builtin.file:
    path: /swapfile
    owner: root
    group: root
    mode: 0600
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Make swap
  ansible.builtin.command: mkswap /swapfile
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Add swap to fstab
  ansible.builtin.lineinfile:
    dest: /etc/fstab
    regexp: "swapfile"
    line: "/swapfile none swap sw 0 0"
    state: present
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Turn swap on
  ansible.builtin.command: swapon -a
  changed_when: false
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Setup vm.swappiness in /etc/sysctl.conf
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "10"
    sysctl_set: yes
  when: not swapfile_exist.stat.exists
  tags: swap

- name: Setup vm.vfs_cache_pressure in /etc/sysctl.conf
  ansible.posix.sysctl:
    name: vm.vfs_cache_pressure
    value: 50
    sysctl_set: yes
  when: not swapfile_exist.stat.exists
  tags: swap
